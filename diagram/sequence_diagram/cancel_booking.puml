@startuml
skinparam style strictuml
autoactivate on

participant "Program / Test Script" as Program
participant "ReserveSystem\n(Controller)" as System
participant "Customer\n(Entity)" as Customer
participant "Booking\n(Entity)" as Booking
participant "Policy\n(Entity)" as Policy
participant "Room\n(Entity)" as Room
participant "Equipment\n(Entity)" as Equipment
participant "Payment\n(Entity)" as Payment
participant "PaymentChannel\n(Entity)" as Channel

title Cancellation Process

Program -> System : process_cancellation(customer_id, booking_id)

    loop [in self.customer_list]
        System -> Customer : get_id()
        return id
    end

    alt [Customer Match Found]
        
        System -> Customer : get_transaction_list()
        return transaction_list

        loop [in transaction_list]
            System -> Booking : get_booking_id()
            return id
        end

        alt [Booking Match Found]
            
            System -> Policy : check_cancel_rule(Booking Object)
            return isAllowed, refund_amount

            alt [isAllowed == true]
                
                System -> Booking : change_booking_status(CANCELLED)
                return void

                System -> Booking : get_room()
                return Room Object
                
                System -> Room : update_room_status(AVAILABLE)
                return void

                System -> Booking : get_equipment_list()
                return equipment_list

                loop [in equipment_list]
                    System -> Equipment : set_status(AVAILABLE)
                    return void
                end

                System -> Payment : process_payment(refund_amount)
                    Payment -> Channel : process(refund_amount)
                    return success
                return refund_completed
                
                System --> Program : return "Success"

            else [isAllowed == false]
                System --> Program : return "Error: Policy Violation"
            end

        else [Booking Not Found]
            System --> Program : return "Error: Booking Not Found"
        end

    else [Customer Not Found]
        System --> Program : return "Error: Customer Not Found"
    end

@enduml